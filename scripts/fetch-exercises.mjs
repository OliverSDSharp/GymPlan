// scripts/fetch-exercises.mjs
// Fetches exercises from free-exercise-db and writes them as a TypeScript file.

import { writeFileSync, readFileSync } from 'node:fs';
import { resolve, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = resolve(__dirname, '..');

const GITHUB_URL =
  'https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/dist/exercises.json';

const VALID_LEVELS = new Set(['beginner', 'intermediate', 'expert']);

function normalizeLevel(level) {
  if (typeof level === 'string' && VALID_LEVELS.has(level.toLowerCase())) {
    return level.toLowerCase();
  }
  return 'intermediate';
}

async function main() {
  // 1. Fetch exercises from GitHub
  console.log(`Fetching exercises from:\n  ${GITHUB_URL}\n`);
  const res = await fetch(GITHUB_URL);
  if (!res.ok) {
    throw new Error(`Failed to fetch exercises: ${res.status} ${res.statusText}`);
  }
  const rawExercises = await res.json();
  console.log(`Fetched ${rawExercises.length} exercises from GitHub.\n`);

  // 2. Read existing exercise IDs from exercises.ts to detect duplicates
  const existingFile = resolve(ROOT, 'src/data/exercises.ts');
  const existingSource = readFileSync(existingFile, 'utf-8');
  // Extract all id values from the existing file
  const idRegex = /id:\s*["']([^"']+)["']/g;
  const existingIds = new Set();
  let match;
  while ((match = idRegex.exec(existingSource)) !== null) {
    existingIds.add(match[1].toLowerCase());
  }
  console.log(`Found ${existingIds.size} existing exercise IDs in exercises.ts.\n`);

  // 3. Map and deduplicate
  const seenIds = new Set();
  const exercises = [];

  for (const ex of rawExercises) {
    const idLower = (ex.id || '').toLowerCase();
    if (!idLower) continue;

    // Skip if already in existing exercises or already seen in this batch
    if (existingIds.has(idLower) || seenIds.has(idLower)) continue;
    seenIds.add(idLower);

    exercises.push({
      id: ex.id,
      name: ex.name || ex.id,
      level: normalizeLevel(ex.level),
      equipment: ex.equipment || 'body only',
      primaryMuscles: ex.primaryMuscles || [],
      secondaryMuscles: ex.secondaryMuscles || [],
      instructions: ex.instructions || [],
      force: ex.force || undefined,
      mechanic: ex.mechanic || undefined,
      category: ex.category || undefined,
      images: ex.images || undefined,
    });
  }

  console.log(
    `After removing ${rawExercises.length - exercises.length - [...existingIds].length} duplicates ` +
    `(${existingIds.size} from existing exercises.ts), ` +
    `${exercises.length} new exercises remain.\n`
  );

  // 4. Build the TypeScript source
  const lines = [
    "import type { Exercise } from '../types/exercise';",
    '',
    '// Auto-generated by scripts/fetch-exercises.mjs',
    `// Source: ${GITHUB_URL}`,
    `// Generated: ${new Date().toISOString()}`,
    `// Total exercises: ${exercises.length}`,
    '',
    'export const GITHUB_EXERCISES: Exercise[] = [',
  ];

  for (const ex of exercises) {
    // Build object fields inline
    const fields = [];
    fields.push(`id: ${JSON.stringify(ex.id)}`);
    fields.push(`name: ${JSON.stringify(ex.name)}`);
    fields.push(`level: ${JSON.stringify(ex.level)}`);
    fields.push(`equipment: ${JSON.stringify(ex.equipment)}`);
    fields.push(`primaryMuscles: ${JSON.stringify(ex.primaryMuscles)}`);
    fields.push(`secondaryMuscles: ${JSON.stringify(ex.secondaryMuscles)}`);
    fields.push(`instructions: ${JSON.stringify(ex.instructions)}`);
    if (ex.force !== undefined) fields.push(`force: ${JSON.stringify(ex.force)}`);
    if (ex.mechanic !== undefined) fields.push(`mechanic: ${JSON.stringify(ex.mechanic)}`);
    if (ex.category !== undefined) fields.push(`category: ${JSON.stringify(ex.category)}`);
    if (ex.images !== undefined) fields.push(`images: ${JSON.stringify(ex.images)}`);

    lines.push(`  { ${fields.join(', ')} },`);
  }

  lines.push('];');
  lines.push('');

  const tsContent = lines.join('\n');

  // 5. Write the output file
  const outPath = resolve(ROOT, 'src/data/exercises-github.ts');
  writeFileSync(outPath, tsContent, 'utf-8');
  console.log(`Wrote ${exercises.length} exercises to:\n  ${outPath}\n`);
  console.log('Done!');
}

main().catch((err) => {
  console.error('Error:', err.message);
  process.exit(1);
});
